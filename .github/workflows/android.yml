- name: Set up Node
  uses: actions/setup-node@v4
  with:
    node-version: '20'

- name: Install deps
  run: npm ci

- name: Write .env for Vite
  run: echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env

- name: Build web (Vite)
  run: npm run build

- name: Set up Java 17
  uses: actions/setup-java@v4
  with:
    distribution: temurin
    java-version: '17'

- name: Cache Gradle
  uses: actions/cache@v4
  with:
    path: |
      ~/.gradle/caches
      ~/.gradle/wrapper
    key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
    restore-keys: |
      ${{ runner.os }}-gradle-

- name: Capacitor Android sync
  run: npx cap sync android

- name: Build Debug APK
  working-directory: android
  run: ./gradlew assembleDebug

- name: Upload APK artifact
  uses: actions/upload-artifact@v4
  with:
    name: app-debug
    path: android/app/build/outputs/apk/debug/*.apk
